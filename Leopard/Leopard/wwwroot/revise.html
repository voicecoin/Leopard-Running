<!DOCTYPE html>
<html mip>
  
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
      <meta name="description" content="最简易的聊天机器人设计及协作平台，十分钟轻松制作我的聊天机器人！集成深度神经网络、知识图谱、和自然语言处理的超强技术" />
    <title>我的工作室</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrapValidator.css" />
	<link rel="stylesheet" href="css/jquery-ui.css" >
    <link rel="stylesheet" type="text/css" href="css/robot.css">
    <link rel="stylesheet" type="text/css" href="css/scrollstyle.css">
    <script src="js/jquery.min.js"></script>
	<script src="js/jquery.cookie.js"></script>
    <script src="js/bootstrap.min.js"></script>
	<script src="js/jquery-ui.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/bootstrapValidator.js"></script>
    <script src="js/validate.js"></script>
    <style>
    @media screen and (max-width: 750px) { 
    .cont_2 { margin: 0 auto; margin-bottom: 30px; } 
    .cont_1_body {width: 95%;}
    }
    input, select, textarea {
    font-style: normal;
    font-variant: normal;
    font-weight: 300;
    font-size: 14px;
    font-family: Roboto,sans-serif;
    vertical-align: middle;
}

@media screen and (max-width: 750px)

</style>
    <script type="text/javascript">
    
      var bots = [];
	  var currentBot=null;
	  
	  function delBot(id){
	      $.ajax({
	    	  url: host + '/v1/Agents/'+id,
	    	  type: 'DELETE',
	    	  data: {},
	    	  success: function(json) {
	    		  botsList();
	    	     //console.dir(json);
	    	  },error: function(e) {
	    		  s_tip("错误",e);
	    	  }
	    	});

	  }
	  //avatar
	  function editBot(id){
	      $.ajax({
	    	  url: host + '/v1/Agents/'+id,
	    	  type: 'GET',
	    	  data: {},
	    	  success: function(json) {
	    		  currentBot=json;
	    		  $("#modal_bot").modal('show');
	             
	              initBotInfo();
	    	  },error: function(e) {
	    		  currentBot=null;
	    		  s_tip(e,'fail');
	    	  }
	    	});
	  }
	  
	  
	  var image = '';
	  function selectImage(file){
	  	if(!file.files || !file.files[0]){
	 		return;
	    }
	  	image = '';
		var reader = new FileReader();
		reader.onload = function(evt){
			document.getElementById('avatar').src = evt.target.result;
			image = evt.target.result;
			//updateBot();
			
	    }
		reader.readAsDataURL(file.files[0]);
	  }
	  
	  function openfile(){
		  document.getElementById('file_image').click();
	  }
	  
      function createBot(){
    		var data={};
    		data.name=$("#name").val();
    		data.description=$("#description").val();
    		data.isPublic=$('#isPublic').is(':checked')?1:0;
    		data.userId=$.cookie("userId");
    		data.avatar=image;
    		$.ajax({
    			url: host + '/v1/Agents',
    			type: "POST",
    			datType: "JSON",
    			contentType: "application/json",
    			data: JSON.stringify(data),
    			success: function () {
    				s_tip("创建成功",'ok');
     			   $("#clo_img").click();
    			},error: function(e) {
    				s_tip(e,'fail');
  	    	  	}
    		});
    		
    	}
      
      
      function updateBot() {
    		var data = {};
   	        data.id = $("#updateId").val();
   	        data.name=$("#name").val();
       		data.description=$("#description").val();
       		data.isPublic=$('#isPublic').is(':checked')?1:0;
       		data.avatar=image;
       		$.ajax({
    			url: host + '/v1/Agents/'+currentBot.id,
    			type: "PUT",
    			datType: "JSON",
    			contentType: "application/json",
    			data: JSON.stringify(data),
    			success: function () {
    			   s_tip("已更新",'ok');
    			   $("#clo_img").click();
    			},error: function(e) {
  	    		   s_tip(e,'fail');
  	    	    }
    		});
      }
	  function showCreate(){
		  var bot={};
		  bot.id='';
		  bot.name='';
		  bot.description='';
		  bot.isPublic=false;
		  $("#modal_bot").modal('show');
          currentBot=bot;
          initBotInfo();
	  }	
      	
      function initBotInfo() {
    	if(currentBot.id.length==0){
    		$("#start").html('+ 创建');
    		$("#bottitle").html("创建聊天机器人");
    	}else{
    		$("#start").html('  保存');
    		$("#bottitle").html("设置聊天机器人");
    	}
        $("#updateId").val(currentBot.id);
        $("#name").val(currentBot.name);
        $("#description").val(currentBot.description);
        $('#isPublic:first').attr("checked", currentBot.isPublic);
        if(currentBot.avatar!=null)
        	$('#avatar').attr("src", currentBot.avatar);
      }

      function getBot(id){
    	  for (var i = 0; i < bots.length; i++) {
    		  if(bots[i].id==id){
    			  bots[i].avatar='';
    			  return bots[i];
    		  }
    	  }
    	  return null;
      }
      
      function editIntent(id){
    	  //id='f3123461-cdeb-4f0f-bdea-8b2c984115e8';
    	  console.log("id="+id);
    	  var currentBot=getBot(id);
    	  $.cookie("currentBot",JSON.stringify(currentBot),{"expires":1});
    	  
    	  window.location.href='intent.html?agentId='+id;
      }
      
      function editEntity(id){
    	  var currentBot=getBot(id);
    	  var s=JSON.stringify(currentBot);
    	  console.log(s);
    	  $.cookie("currentBot",JSON.stringify(currentBot),{"expires":1});
    	  window.location.href='entities.html?agentId='+id;
      }
      
      function testdialog(id){
    	var currentBot=getBot(id);
    	$.cookie("currentBot",JSON.stringify(currentBot),{"expires":1});
		$("#dialog-modal").dialog(
	  		{
	  			modal: true,
	  			height:500,
	  			title:currentBot.name+" 会话测试"
	  		}
	  	); 
		
		$("#testtxt").off("keyup").on('keyup',function(e){
			var v=$(this).val().replace('&nbsp;','').replace(/\r\n/g,'').replace(/\n/g,'');
			if(e.keyCode == 13 ){
				if(v.length>0){
					sendTest();
				}
				return false;
			}
		});
		
	  }
      
      
      
      
      function sendTest(){
    		var testtxt=$("#testtxt").val();
    		if(testtxt.length>0){
    			
    			var html='<div class="ui_right_right">';
    			
    			html+='<span>'+testtxt+'</span>';
    			html+='<img  src="images/ui_10.jpg" />';
    			html+='</div>';
    			$("#testcontent").append(html);
    			
    			var currentBot=JSON.parse($.cookie("currentBot"));
    			var url=host + "/v1/Conversation/Text?ClientAccessToken="+currentBot.clientAccessToken+"&SessionId="+currentBot.userId+"&Text="+testtxt;

                $.get(url, null, function (json) {
                    var html = '<div class="ui_right_mid">';

                    html += '<img  src="images/ui_06.jpg" />';
                    html += '<span>' + json + '</span>';
                    html += '</div>';
                    $("#testcontent").append(html);

                    console.log("$('#testcontent').height()=" + $('#testcontent').get(0).scrollHeight);
                    $('#testcontent').animate({ scrollTop: $('#testcontent').get(0).scrollHeight }, 300);
                    $("#testtxt").val('');
                }, 'text');
    		}
    	}
      

      function botsList() {
        //var data = {};
        //data.Type = "No Auth";
        var userId=$.cookie("userId");
        if(userId==null){
        	//window.location.href="login.html";
        	$("#nobotmsg").show();
        	return;
        }
        $.get(host + '/v1/Agents/'+userId+'/Query', null,function(json) {
          //console.log(json);
          $("#createDiv").show();
          
          bots = json.items;
          
          if(bots.length>0){
        	  var robts = '';
              for (var i = 0; i < bots.length; i++) {
                var robt = bots[i];
                robts += '<div id="bot'+robt.id+'" class="col-md-3 col-sm-6">';
                robts += '<div class="cont_2" id="conts' + robt.id + '" style="">';
                robts += '	    <div class="cont_2_top">';
                if(robt.avatar!=null){
                	robts += '<img class="botIcon" src="'+robt.avatar+'" data-bd-imgshare-binded="1">';
                }else{
                	robts += '<img class="botIcon" src="images/int_02.jpg" data-bd-imgshare-binded="1">';
                }
                
                robts += '</div>';
                robts += '<div class="cont_2_btm">';
                robts += '<span>' + robt.name + '</span>';
                robts += '<p>' + getDateDiff(getDateTimeStamp(robt.createdDate)) + '创建</p>';
                robts += '</div>';
                robts += '</div>';
                robts += '<div class="cont_2" id="ashow' + robt.id + '" style="display: none;">';
                robts += '<div class="cont_2_hide">';
                
                robts += '<div class="cont_2_11"><a href="javascript:void(0);" onclick="editIntent(\''+robt.id+'\')">编辑意图</a></div>';
                robts += '<div class="cont_2_11"><a href="javascript:void(0);" onclick="editEntity(\''+robt.id+'\')">编辑词库</a></div>';
                
                robts += '<div class="row" style="font-size:1.5em;">';
                robts += '	<div class="col-md-2"></div>';
                robts += '	<div class="col-md-2"><a href="javascript:void(0);" onclick="editBot(\'' + robt.id + '\');"><span class="glyphicon glyphicon-cog"></span></a></div>';
                //glyphicon glyphicon-share
                //robts += '	<div class="col-md-2"><a class="contshow" href="##" id="shareshow1"><span><img src="images/ui_font.jpg" data-bd-imgshare-binded="1"></span></a></div>';
                robts += '	<div class="col-md-2"><a href="##"><span class="glyphicon glyphicon-share"></span></a></div>';
                
                robts += '	<div class="col-md-2"><a href="javascript:void(0);" onclick="testdialog(\'' + robt.id + '\');"><span class="glyphicon glyphicon-play"></span></a></div>';
                robts += '	<div class="col-md-2 ">';
                robts += '<li class="dropdown col-center-block" style="list-style-type:none">';
                robts += '<a href="#" class="dropdown-toggle" data-toggle="dropdown">';
        		robts += '<span class="glyphicon glyphicon-option-vertical"></span>';
        		robts += '</a>';
        		robts += '<ul class="dropdown-menu directionup">';
        		robts += '<li><a href="#">创建副本</a></li>';
        		//robts += '<li><a href="#">移动</a></li>';
        		robts += '<li class="divider"></li>';
        		robts += '<li><a href="javascript:void(0);" onclick="delBot(\''+robt.id+'\')">删除</a></li>';
        		robts += '</ul>';
        		robts += '</li>';
        		robts += ' </div>';
        		 robts += '	<div class="col-md-2"></div>';
                robts += ' </div>';
                robts += '</div>';
                robts += '</div>';
                robts += '</div>';
              }
              $(".row").html(robts);
    	      
              $(".row").on('mouseenter', '.cont_2', function() {
                var id = $(this).attr("id").replace("conts", '').replace("ashow", '');
                $("#conts" + id).hide();
                $("#ashow" + id).show();
              });

              $(".row").on('mouseleave', '.cont_2',  function() {
                var id = $(this).attr("id").replace("conts", '').replace("ashow", '');
                $("#ashow" + id).hide();
                $("#conts" + id).show();
              });

              $(".row").on('mouseenter', '.contshow', function() {
                var id = $(this).attr("id").replace("shareshow", '').replace("bdbox", '');
                $("#bdbox" + id).show();
              });

              $(".row").on('mouseenter', '.contshow', function() {
                var id = $(this).attr("id").replace("shareshow", '').replace("bdbox", '');
                $("#bdbox" + id).hide();
              });
          }else{
        	  $(".row").empty();
        	  $("#nobotmsg").show();
          }
         
			
        });
      }

      $(document).ready(function() {
        $.get("head.html", function(data) {
           $('#header').html(data);
        });
        botsList();
        botValidate('#form1');
        
        $("#start").on('click',function(){
        	var bootstrapValidator = $("#form1").data('bootstrapValidator');
        	bootstrapValidator.validate();
        	if (bootstrapValidator.isValid()) {
        		
        		if(currentBot.id.length==0){
        			createBot();
        		}else{
        			updateBot();
        		}
        		
        	}
          });
        
        $("#name").focus(function(){
            $("#sn_img1").attr("src","images/zhuce_01_b.png");
           
          });
          $("#name").blur(function(){
            $("#sn_img1").attr("src","images/zhuce_01.png");
           
          });
          $("#description").focus(function(){
            $("#sn_img2").attr("src","images/zhuce_03_b.png");
           
          });
          $("#description").blur(function(){
            $("#sn_img2").attr("src","images/zhuce_03.png");
           
          });

      });
</script>
  </head>
  
  <body style="height: auto;">
    <div id="header"></div>
    <div class="content">
      <!-- 机器人列表 -->
       <div id="nobotmsg" style="display:none;margin-top: 100px;">
       <img class="img_lg" src="images/int_01.png">
	   <div class="headline">
			<h2>你还没有创建聊天机器人</h2>
			<h4>您可以在这里创建，或者选择模板创建</h4>
	   </div>
      </div>
      
      <div class="row"></div>
      <div id="createDiv" style="margin-bottom: 30px;display:none">
        <a href="javascript:void();" onclick="showCreate();">
          <button type="button" class="btn btn-primary btn-lg btn-block">+&nbsp&nbsp创建聊天机器人</button></a>
      </div>
    </div>
    <!-- 修改机器人弹出层 -->
    <div id="modal_bot" class="modal fade" tabindex="-1" role="dialog">
    <form id="form1" method="post" class="class="form-horizontal">
      <input type="hidden" id="updateId" />
      <div class="modal-dialog" role="document">
        <div class="content">
          <div class="cont_1">
	<span class="cont_1_span"><a href="revise.html"><img id="clo_img"  src="images/clo_b.png" /></a></span>
	<div class="cont_1_body">
		<h3 id="bottitle">创建聊天机器人</h3>
		<div class="zc_box">
			<div class="form-group zc_box_1" id="zc_box1">
				<div class="zc_box_logo">
					<img id="sn_img1" src="images/zhuce_01.png" />
				</div>
				<input id="name" class='input-lg form-input name form-control' name="name" placeholder='名字'>
			</div>
			<div class="form-group zc_box_1" id="zc_box2">
				<div class="zc_box_logo">
					<img id="sn_img2"  src="images/zhuce_05.jpg" />
				</div>
				<input id="description" class='input-lg form-input name form-control' name="description" placeholder='备注'>
			</div>
		</div>
		<div class="chk">
			<input name="是否公开" type="checkbox" value="1" id="isPublic"/>
			<span class="chk_span">是否公开</span>
		</div>
		<div class="setdata">
			<div class="setdata_left botIcon">
				<img id="avatar" class="botIcon" src="images/int_02.jpg" />
			</div>
			<div class="setdata_right">
			    <div style="display:none"><input type="file" onchange="selectImage(this);" accept="image/*" id="file_image" name="file_image"/></div>
				<div class="setdata_right_top"><a href="javascript:void(0);" onclick="openfile();">上传新图标</a></div>
				<div class="setdata_right_btm">图标 （尺寸 120 x 120）</div>
			</div>
			
		</div>
		<a class="btn btn-lg btn-primary" href="javascript:void();" id="start">+  创建</a>
        </div>
        </div>
        </div>
      </div>
      </form>
    </div>


<!-- <div id="dialog-modal" title="会话测试"  style="display:none;">
  <div class="dialog_mian">
	<div id="testcontentdialog"></div>
	<div class="ui_right_btm1" id="dialog_btm">
		<input id="testtxtdialog" class="" type="text" style="width:60%" placeholder="   输入对话">
	    <button type="button" onclick="sendTestDialog();">发  送</button>
	</div>
  </div>
</div> -->

<div id="dialog-modal" title="会话测试"  style="display:none;">
	<div class="ui_right_main">


		<div id="testcontent" class="style-1" style="height:350px;overflow-y: auto">
		
		
		</div>
		<div class="ui_right_btm" style="position: relative;bottom:0px">

			<input id="testtxt" class="" type="text" style="width:60%" placeholder="   输入对话">
			<button type="button" id="sendTest" onclick="sendTest();">发  送</button>

		</div>

	</div>
</div>
</body>

</html>

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a0ffd8247abd4a38f87f03db9e6c79a7";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>